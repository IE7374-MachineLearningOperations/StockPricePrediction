name: Train Machine Learning Model on GCP

on:
  push:
    branches:
      - citest 
jobs:
  setup-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2 

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v0.2.0
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
        export_default_credentials: true  

    - name: Train models on Vertex AI
      run: |
        gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
        gcloud ai custom-jobs create \
          --region=${{ secrets.GOOGLE_CLOUD_REGION }} \
          --display-name=model-training \
          --args="--input-data=gs://${{ secrets.GCS_BUCKET_NAME }}/Data/pipeline/airflow/dags/data/final_scaled_data.csv" \
          --python-package-uris=gs://${{ secrets.GCS_BUCKET_NAME }}/gcp_deploy/best_model.py \
          --worker-pool-spec="machine-type=n1-standard-4,python-version=3.7,executor-image-uri=us-docker.pkg.dev/vertex-ai/training/tf-cpu.2-5:latest,local-package-path=./trainer" \
    - name: Notify completion
      uses: actions/github-script@v5
      with:
        script: |
          github.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'Model training has been completed ðŸš€'
          })
